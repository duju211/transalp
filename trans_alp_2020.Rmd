---
title: "Getting Over It"
description: |
  Visualising my Transalp bike ride
author:
  - name: Julian During
date: "`r Sys.Date()`"
repository_url: https://github.com/duju211/transalp
creative_commons: CC BY
---

In the summer of 2020 I crossed the alps with my road bike.
I've recorded the whole ride and as a nice memory,
I would like to visualise this ride. 

A short time ago I've discovered the awesome R package `targets`.
The use of this package
transformed the way I do my analysis and it helps me to make my work more 
reproducible.

If you want to reproduce this analysis, you have to perform the following
steps:

* Install at least R 4.1.0 (use of the new base pipe)
* Clone the [repository](https://github.com/duju211/transalp)
* Install the packages in the `libraries.R` file
* Run targets pipeline with `targets::tar_make()`

# Data

I will describe the most important steps of the analysis in more detail.

At first, load the necessary libraries:

```{r message=FALSE, warning=FALSE, include=FALSE}
source("libraries.R")
```

```{r, code=read_lines("libraries.R"), eval=FALSE}
```

Load raw data from `rds` file `r tar_read(act_meas_path)`.

```{r, code=read_lines("R/read_data.R")}
```

The input files contain all the data of my 5 days on the bike. Every row is a
measurement of one point in time on my trip:

```{r, echo=FALSE}
tar_read(df_act_meas)
```

# Preprocessing

Do some basic preprocessing:

* Arrange measurements based on time
* Turn activity date into character (for easier plotting)
* Include a row number to make it easier to identify each record later on
* Turn distance from meters into kilometers

```{r pre_process_meas, code=read_lines("R/pre_process_meas.R")}
```

Nest the data frame by `id` and `act_date_chr`. Create a new `sf` column with
the geospatial information of the activities:

```{r convert_to_sf, code=read_lines("R/convert_to_sf.R")}
```

Every activity is now represented by one row. The `geom` column holds the
geospatial data in a list column:

```{r, echo=FALSE}
tar_read(sf_act_meas)
```

Define important points of interest on the route (based on their row number).
Also include a small offset in a separate column. This will help to improve the
plot later on:

```{r extract_poi, code=read_lines("R/poi.R")}
```

# Visualisation

## Altitude

Visualise the altitude data:

```{r vis_altitude, code=read_lines("R/vis_altitude.R")}
```


## Spatial Data

Determine the map data for all the activities. Use the `ggmap::get_stamenmap`
function to download the data. The bounding box is calculated from the
`sf_act_meas` object.

```{r get_alpen_map, code=read_lines("R/get_alpen_map.R")}
```

```{r gg_alpen, echo=FALSE}
ggmap::ggmap(tar_read(gg_alpen))
```


Plot the activity and the point of interest data onto the map. Use the 
`ggrepel` package to plot the labels of the points of interest. This avoids
too much overplotting.

```{r vis_ride, code=read_lines("R/vis_ride.R")}
```

```{r gg_rides, echo=FALSE}
tar_read(gg_rides)
```

## Combine Visualisations

Combine everything into one big plot using the `patchwork` package:

```{r transalp_plot_final, code=read_lines("R/vis_transalp.R")}
```

```{r}
knitr::include_graphics(tar_read(png_transalp), error = TRUE)
```

